## 4 分析函数

分析函数能够用于过程性的计数，得到基于某种顺序进行特定计算后的“实时”结果（这里的“实时”一般代表前n行数据进行计算后的结果，不会考虑第n+1行之后的数据），相较于聚合函数，分析函数能够根据单一的分组依据，显示多列结果（聚合函数需要对显示的所有其他项均放入GROUP BY语句之后）。使用分析函数，能够完成不限于以下的功能：

- 将其他行的数据放到本行中；
- 显示前n个结果；
- 执行带等级的查询；
- 计算动态的平均值（前n条数据的平均值）等。

### 4.1 基本使用方法

使用方法：
- 关键字OVER()函数；
- PARTITION BY分组；
- ORDER BY排序。

```SQL
--使用分析函数计算每个部门前n个员工的工资平均值
SELECT dept, ename, salary OVER(PARTITION BY dept ORDER BY ename)
FROM employee
ORDER BY ename;
```
### 4.2 开窗函数与窗口大小设置

开窗函数主要分为两种，分为排名开窗函数与聚合开窗函数。排名开窗函数中包含：

- ROW_NUMBER()：返回按顺序排列后每一行所在分组的行号（即输出每一行是分组里的第几行）；
- DENSE_RANK()：返回每一行按某个字段值的大小进行排名后的名次，相同值的行具有相同的排名，但并且不会跳过排名（例如同时有两个第2名，那么下一个仍旧是第3名而不是第4名）；
- RANK()：返回每一行按某个字段值大小进行排名后的名词，相同值的行具有相同的排名，但与DENSE_RANK()不同的是，RANK()采用的是标准的排行计数规则，具有多个相同的排名时，后面对应的排名将会跳过。（例如同时有两个第2名，那么下一个将是第4名）。

> 使用排名开窗函数，OVER()函数内可以有PARTITION BY关键字进行分组，也可以有ORDER BY进行排序，也可以两者都有。

聚合开窗函数类似于聚合函数，其主要种类包含：

- SUM(exp)：取总和；
- AVG(exp)：取平均值；
- MIN(exp)：取最小值；
- MAX(exp)：取最大值；
- COUNT(exp)：取行计数。

> 使用聚合开窗函数，需要使用PARTITION BY关键字进行分组，但是ORDER BY不能与聚合开窗函数一同使用。

除此之外，还有一些其他特殊的函数：

- FIRST_VALUE(exp)：按行排列顺序取所有满足条件的第一个值；
- LAST_VALUE(exp)：按行排列顺序取所有满足条件的最后一个值；
- LAG(exp, n)：使用此函数可以将某一列数据的前n行对应值赋到本行数据中，使用此函数可以将同一字段不同行的值放到同一行中，方便进行处理或进行运算；
- LEAD(exp, n)：与LAG()相似，使用此函数可以将某一列数据的后n行对应值赋到本行数据中，使用此函数同样可以将同一字段不同行的值放到同一行中，方便进行处理或进行运算；

> 如果使用LAG或者LEAD的分析函数，对应的目标数据不存在，则以空值NULL代替。（例如选取前5行的数据时，第1-5行的前5行数据不存在，则会以空值NULL填入第1-5行的对应字段）

设置窗口大小的方法：

- RANGE：开窗范围为满足本行某一列属性值在一定范围区间内的所有行，以这种方法进行分组的窗口大小一般不固定；
- ROWS：开窗范围为该行前/后n行数据，以这种方法进行分组的窗口大小一般是固定的。

```SQL
--显示每个员工入职时间前一个月时间里，第一个入职的员工
--如果不存在在前一个月时间内入职的其他员工则会显示自己的名字
SELECT dept, ename, hiredate, FIRST_VALUE(ename) OVER(ORDER BY hiredate DESC RANGE 30 PRECEDING)
FROM employee
ORDER BY hiredate DESC;
```